<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Program Genel Bakış</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="dashboard-container">
    <nav class="dashboard-nav">
      <h2>Program Genel Bakış</h2>
      <ul>
        <li><a href="user_dashboard.html">🏠 Ana Sayfa</a></li>
        <li><a href="progress_tracking.html">📊 İlerleme</a></li>
        <li><a href="messages.html">💬 Mesajlar</a></li>
        <li><a href="logout.html">🚪 Çıkış Yap</a></li>
      </ul>
    </nav>

    <main class="dashboard-content">
      <h2 id="program-name">Program Adı</h2>
      <p id="program-description">Program açıklaması burada görünecek.</p>

      <!-- 📆 Workout Schedule -->
      <section id="workout-schedule">
        <h3>Günlük Antrenmanlar</h3>
        <ul id="workout-list"></ul>
      </section>

      <!-- 📜 Coach Notes -->
      <section id="coach-notes">
        <h3>Koç Notları</h3>
        <p id="coach-notes-content">Koçunuzun eklediği notlar burada görünecek.</p>
      </section>

      <!-- 💪 Strength Progress -->
      <section id="strength-progress">
        <h3>Güç Gelişimi</h3>
        <canvas id="strengthChart"></canvas>
      </section>

      <!-- 🎥 Embedded Workout Videos (Multiple Videos per Day) -->
      <section id="workout-videos">
        <h3>Antrenman Videoları</h3>
        <div id="video-container"></div>
      </section>

      <!-- ✅ Completion Summary -->
      <section id="program-completion">
        <h3>Program Tamamlama Oranı</h3>
        <p id="completion-rate">Tamamlama Oranı: %0</p>
      </section>

      <!-- ⭐ Feedback Section -->
      <section id="program-feedback">
        <h3>Program Geri Bildirimleri</h3>
        <ul id="feedback-list"></ul>
      </section>

      <!-- 🌙 Dark Mode Toggle -->
      <button id="dark-mode-toggle">🌙 Karanlık Mod</button>
    </main>
  </div>
  <script>

  const BASE_URL = "https://kulvar.onrender.com";
  const token = localStorage.getItem("token");
  
  async function fetchProgramDetails() {
    const params = new URLSearchParams(window.location.search);
    const programId = params.get("id");
  
    if (!programId) {
      document.getElementById("program-name").textContent = "Program Bulunamadı";
      return;
    }
  
    try {
      const response = await fetch(`${BASE_URL}/programs/${programId}`, {
        method: "GET",
        headers: { Authorization: `Bearer ${token}` },
      });
  
      const program = await response.json();
      if (response.ok) {
        displayProgramDetails(program);
      } else {
        console.error("Error fetching program details:", program.message);
      }
    } catch (error) {
      console.error("Hata:", error.message);
    }
  }
  
  function displayProgramDetails(program) {
    // Program Details
    document.getElementById("program-name").textContent = program.name || "Program Adı Bulunamadı";
    document.getElementById("program-description").textContent = program.description || "Program açıklaması mevcut değil.";
  
    // Display other sections
    displayWorkoutSchedule(program.dailySchedule || []);
    displayCoachNotes(program.dailySchedule || []);
    loadStrengthProgress(program.progressiveOverload || []);
    fetchProgramCompletion(program._id);
    fetchProgramFeedback(program._id);
  }
  
  function displayWorkoutSchedule(dailySchedule) {
    const workoutList = document.getElementById("workout-list");
    workoutList.innerHTML = "";
  
    if (dailySchedule.length === 0) {
      workoutList.textContent = "Antrenman programı bulunamadı.";
      return;
    }
  
    dailySchedule.forEach(day => {
      const li = document.createElement("li");
      li.innerHTML = `<p><strong>${day.day || "Gün Bilinmiyor"}:</strong></p>`;
  
      day.sessions.forEach(session => {
        li.innerHTML += `<p><strong>${session.name || "Antrenman Adı Yok"}:</strong> 
          ${session.exercises.map(ex => ex.name || "Egzersiz Adı Yok").join(", ")}</p>`;
  
        // Embed videos if available
        session.exercises.forEach(ex => {
          if (ex.videoUrls && ex.videoUrls.length) {
            ex.videoUrls.forEach(video => {
              li.innerHTML += `<iframe width="300" height="200" src="${video.url}" frameborder="0" allowfullscreen></iframe>`;
            });
          }
        });
      });
  
      workoutList.appendChild(li);
    });
  }
  
  function displayCoachNotes(dailySchedule) {
    const notesContent = document.getElementById("coach-notes-content");
    notesContent.innerHTML = dailySchedule
      .filter(day => day.notes)
      .map(day => `<p><strong>${day.day || "Gün Bilinmiyor"}:</strong> ${day.notes}</p>`)
      .join("") || "Koç notu bulunamadı.";
  }
  
  function loadStrengthProgress(progressiveOverload) {
    if (progressiveOverload.length === 0) {
      document.getElementById("strengthChart").textContent = "Güç gelişimi verisi bulunamadı.";
      return;
    }
  
    const ctx = document.getElementById("strengthChart").getContext("2d");
    const labels = progressiveOverload.map(ex => ex.exerciseName);
    const weightValues = progressiveOverload.map(ex => ex.currentWeight);
  
    new Chart(ctx, {
      type: "bar",
      data: {
        labels: labels,
        datasets: [{ label: "Şu Anki Ağırlık", data: weightValues, backgroundColor: "green" }],
      },
      options: { responsive: true, maintainAspectRatio: false },
    });
  }
  
  async function fetchProgramCompletion(programId) {
    try {
      const response = await fetch(`${BASE_URL}/programs/${programId}/completion`, {
        headers: { Authorization: `Bearer ${token}` },
      });
  
      const completion = await response.json();
      if (response.ok) {
        document.getElementById("completion-rate").textContent = `Tamamlama Oranı: %${completion.rate || 0}`;
      } else {
        console.error("Error fetching completion data:", completion.message);
      }
    } catch (error) {
      console.error("Error fetching completion data:", error.message);
    }
  }
  
  async function fetchProgramFeedback(programId) {
    try {
      const response = await fetch(`${BASE_URL}/programs/${programId}/feedback`, {
        headers: { Authorization: `Bearer ${token}` },
      });
  
      const feedback = await response.json();
      if (response.ok) {
        const feedbackList = document.getElementById("feedback-list");
        feedbackList.innerHTML = feedback.map(fb => `
          <li><strong>${fb.userName || "Kullanıcı"}:</strong> ${fb.comment || "Yorum Yok"} (${fb.rating || 0}/5)</li>
        `).join("") || "Geri bildirim bulunamadı.";
      } else {
        console.error("Error fetching feedback:", feedback.message);
      }
    } catch (error) {
      console.error("Error fetching feedback:", error.message);
    }
  }
  
  // Dark Mode Toggle
  document.getElementById("dark-mode-toggle").addEventListener("click", () => {
    document.body.classList.toggle("dark-mode");
    localStorage.setItem("darkMode", document.body.classList.contains("dark-mode") ? "enabled" : "disabled");
  });
  
  // Enable Dark Mode if Previously Selected
  if (localStorage.getItem("darkMode") === "enabled") {
    document.body.classList.add("dark-mode");
  }
  
  // Initialize the Dashboard
  document.addEventListener("DOMContentLoaded", fetchProgramDetails);
</script>
</body>
</html>
