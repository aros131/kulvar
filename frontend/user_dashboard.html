<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kulvar Kullanƒ±cƒ± Paneli</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="dashboard-container">
    <!-- Sol Navigasyon Men√ºs√º -->
    <nav class="dashboard-nav">
      <h2>Panelim</h2>
      <ul>
        <li><a href="#profile" class="active">Profil</a></li>
        <li><a href="#my-programs">Programlarƒ±m</a></li>
        <li><a href="#progress">ƒ∞lerleme</a></li>
        <li><a href="#workout-calendar">Takvim</a></li>
        <li><a href="#achievements">Ba≈üarƒ±lar</a></li>
        <li><a href="#messages">Mesajlar</a></li>
        <li><a href="#notifications">Bildirimler</a></li>
        <li><a href="#settings">Ayarlar</a></li>
        <li><a href="user_profile.html">Profilim</a></li>
      </ul>
    </nav>

    <!-- Ana ƒ∞√ßerik -->
    <main class="dashboard-content">
      <!-- Profil B√∂l√ºm√º -->
      <section id="profile">
        <h2>Profilim</h2>
        <p>Ad Soyad: <span id="user-name"></span></p>
        <p>E-posta: <span id="user-email"></span></p>
      </section>

      <!-- Programlarƒ±m -->
      <section id="my-programs">
        <h2>Programlarƒ±m</h2>
        <ul id="program-list"></ul>
      </section>

      <!-- ƒ∞lerleme -->
      <section id="progress">
        <h2>ƒ∞lerleme</h2>
        <canvas id="progressChart"></canvas>
      </section>

      <!-- Takvim -->
      <section id="workout-calendar">
        <h2>Takvim</h2>
        <div id="calendar"></div>
      </section>

      <!-- Ba≈üarƒ±lar -->
      <section id="achievements">
        <h2>Ba≈üarƒ±lar</h2>
        <ul id="badges-list"></ul>
      </section>

      <!-- Mesajlar -->
      <section id="messages">
        <h2>Mesajlar</h2>
        <div id="chat-box"></div>
        <input type="text" id="chat-input" placeholder="Mesajƒ±nƒ±zƒ± yazƒ±n...">
        <button onclick="sendMessage()">G√∂nder</button>
      </section>

      <!-- Bildirimler -->
      <section id="notifications">
        <h2>Bildirimler</h2>
        <ul id="notification-list"></ul>
      </section>
    </main>
  </div>

  <script>
    const BASE_URL = "https://kulvar.onrender.com";
    const token = localStorage.getItem("token");

    function getUserIdFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get("id");
    }

    async function fetchUserData() {
      const userId = getUserIdFromUrl();
      if (!userId || !token) {
        alert("User not authorized");
        window.location.href = "/login.html";
        return;
      }

      try {
        const response = await fetch(`${BASE_URL}/auth/${userId}`, {
          method: "GET",
          headers: { Authorization: `Bearer ${token}` },
        });

        const data = await response.json();
        if (response.ok) {
          document.getElementById("user-name").textContent = data.name;
          document.getElementById("user-email").textContent = data.email;
        }
      } catch (error) {
        console.error("Error fetching user data:", error.message);
      }
    }

    async function fetchUserProgramsForCalendar() {
      try {
        const response = await fetch(`${BASE_URL}/dashboard/user-programs`, {
          method: "GET",
          headers: { Authorization: `Bearer ${token}` },
        });

        const data = await response.json();
        if (response.ok) {
          let calendarHTML = "";
          data.programs.forEach(program => {
            program.dailySchedule.forEach(day => {
              calendarHTML += `<div class="calendar-day"><strong>G√ºn ${day.day}:</strong> ${day.exercises.join(", ")}</div>`;
            });
          });
          document.getElementById("calendar").innerHTML = calendarHTML;
        }
      } catch (error) {
        console.error("Error fetching programs:", error.message);
      }
    }

    async function fetchUserStreaks() {
      const userId = getUserIdFromUrl();
      try {
        const response = await fetch(`${BASE_URL}/progress/streaks/${userId}`, {
          method: "GET",
          headers: { Authorization: `Bearer ${token}` },
        });

        const data = await response.json();
        if (response.ok) {
          let badgesHTML = "";
          if (data.currentStreak >= 7) badgesHTML += `<li>üî• 7 G√ºnl√ºk Streak</li>`;
          if (data.currentStreak >= 14) badgesHTML += `<li>üèÜ 14 G√ºnl√ºk Streak</li>`;
          if (data.maxStreak >= 30) badgesHTML += `<li>üéñ 30 G√ºnl√ºk Streak</li>`;
          document.getElementById("badges-list").innerHTML = badgesHTML;
        }
      } catch (error) {
        console.error("Error fetching streaks:", error.message);
      }
    }

    async function fetchNotifications() {
      try {
        const response = await fetch(`${BASE_URL}/dashboard/notifications/user`, {
          method: "GET",
          headers: { Authorization: `Bearer ${token}` },
        });

        const data = await response.json();
        if (response.ok) {
          document.getElementById("notification-list").innerHTML = data.notifications.map(n => `
            <li>${n.message} <button onclick="markNotificationAsRead('${n._id}')">‚úì</button></li>
          `).join("");
        }
      } catch (error) {
        console.error("Error fetching notifications:", error.message);
      }
    }

    function markNotificationAsRead(notificationId) {
      fetch(`${BASE_URL}/dashboard/notifications/read/${notificationId}`, {
        method: "POST",
        headers: { Authorization: `Bearer ${token}` },
      }).then(() => fetchNotifications());
    }

    function initializeDashboard() {
      fetchUserData();
      fetchUserProgramsForCalendar();
      fetchUserStreaks();
      fetchNotifications();
    }

    document.addEventListener("DOMContentLoaded", initializeDashboard);
  </script>

  <style>
    body {
      font-family: 'Arial', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #F7F9FA;
      color: #28363D;
    }

    .dashboard-container {
      display: flex;
      min-height: 100vh;
    }

    .dashboard-nav {
      width: 250px;
      background-color: #2F575D;
      color: #FFF;
      padding: 20px;
    }

    .dashboard-nav h2 {
      font-size: 22px;
      margin-bottom: 20px;
    }

    .dashboard-nav ul {
      list-style: none;
      padding: 0;
    }

    .dashboard-nav a {
      text-decoration: none;
      color: #FFF;
      display: block;
      padding: 10px;
      border-radius: 5px;
    }

    .dashboard-content {
      flex: 1;
      padding: 20px;
    }

    button {
      background: #658B6F;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 5px;
      cursor: pointer;
    }

    #calendar {
      display: flex;
      flex-wrap: wrap;
    }

    .calendar-day {
      padding: 10px;
      margin: 5px;
      background: #C4CDC1;
      border-radius: 5px;
    }
  </style>
</body>
</html>
